<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Paciente</title>
    <link rel="stylesheet" href="/css/regs2.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <h1 class="title">Registro</h1>
      <p class="subtitle">
        Sistema de cadastro psicol√≥gico ‚Äì Preencha as informa√ß√µes com aten√ß√£o e
        cuidado
      </p>

      <div class="card modal">
        <div class="card-header">
          <span class="icon">üë§</span>
          <div>
            <h2>Dados Pessoais</h2>
            <p>Informa√ß√µes b√°sicas</p>
          </div>
        </div>

        <div
          class="tab-switch"
          role="tablist"
          aria-label="Se√ß√µes do formul√°rio"
        >
          <button
            class="tab-btn active"
            data-tab="personal"
            aria-pressed="true"
          >
            Dados Pessoais
          </button>
          <button class="tab-btn" data-tab="extra" aria-pressed="false">
            Formul√°rio
          </button>
        </div>

        <div class="tab-content">
          <section class="tab-panel tab-personal" data-panel="personal">
            <div
              class="mode-toggle"
              role="tablist"
              aria-label="Modo de registro"
            >
              <button
                class="mode-btn active"
                data-mode="name"
                aria-pressed="true"
              >
                Por Nome
              </button>
              <button class="mode-btn" data-mode="cpf" aria-pressed="false">
                Por CPF
              </button>
            </div>

            <div class="form-grid form-by-name">
              <div class="form-group">
                <label>Nome Completo *</label>
                <input type="text" id="nome" />
              </div>

              <div class="form-group">
                <label>Data de Nascimento *</label>
                <input type="date" id="nascimento" />
              </div>
            </div>

            <div class="form-grid form-by-cpf" style="display: none">
              <div class="form-group full">
                <label>CPF *</label>
                <input type="text" id="cpf" placeholder="000.000.000-00" />
              </div>
            </div>
          </section>

          <section
            class="tab-panel tab-extra"
            data-panel="extra"
            style="display: none"
          >
            <div class="card-header">
              <span class="icon">ü©∫</span>
              <div>
                <h2>Formul√°rio Cl√≠nico / Escolar</h2>
                <p>Assinale as op√ß√µes que se aplicam</p>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group full">
                <label
                  ><input type="checkbox" id="pcd" /> Pessoa com defici√™ncia
                  (PCD)</label
                >
              </div>

              <div class="form-group full">
                <label
                  ><input type="checkbox" id="medicacao" /> Faz uso de
                  medica√ß√µes cont√≠nuas</label
                >
              </div>

              <div class="form-group full">
                <label
                  ><input type="checkbox" id="acompanhamento" /> Est√° em
                  acompanhamento/tratamento com profissionais de sa√∫de</label
                >
              </div>

              <div class="form-group full">
                <label
                  ><input type="checkbox" id="acompanhante" /> Necessita de
                  acompanhante terap√™utico em sala de aula</label
                >
              </div>

              <div class="form-group full">
                <label
                  ><input
                    type="checkbox"
                    id="adaptacao"
                    data-target="adaptacao-detalhe"
                  />
                  Necessita de alguma adapta√ß√£o para acessibilidade</label
                >
                <input
                  class="detail-input"
                  type="text"
                  id="adaptacao-detalhe"
                  placeholder="Descreva a adapta√ß√£o necess√°ria (opcional)"
                />
              </div>

              <div class="form-group full">
                <label
                  ><input
                    type="checkbox"
                    id="dificuldade"
                    data-target="dificuldade-detalhe"
                  />
                  Tem dificuldade de aprendizagem</label
                >
                <input
                  class="detail-input"
                  type="text"
                  id="dificuldade-detalhe"
                  placeholder="Descreva (opcional)"
                />
              </div>

              <div class="form-group full">
                <label
                  ><input
                    type="checkbox"
                    id="reprovacoes"
                    data-target="reprovacoes-detalhe"
                  />
                  Reprova√ß√µes anteriores</label
                >
                <input
                  class="detail-input"
                  type="text"
                  id="reprovacoes-detalhe"
                  placeholder="Quantas / observa√ß√µes (opcional)"
                />
              </div>

              <div class="form-group full">
                <label
                  ><input
                    type="checkbox"
                    id="abandono"
                    data-target="abandono-detalhe"
                  />
                  Abandono de curso</label
                >
                <input
                  class="detail-input"
                  type="text"
                  id="abandono-detalhe"
                  placeholder="Se sim, detalhe (opcional)"
                />
              </div>

              <div class="form-group full">
                <label
                  ><input
                    type="checkbox"
                    id="malestar"
                    data-target="malestar-detalhe"
                  />
                  Mal estar psicol√≥gico (crises de ansiedade, depress√£o)</label
                >
                <input
                  class="detail-input"
                  type="text"
                  id="malestar-detalhe"
                  placeholder="Se sim, descreva (opcional)"
                />
              </div>

              <div class="form-group full">
                <label
                  ><input
                    type="checkbox"
                    id="crises-familiares"
                    data-target="crises-detalhe"
                  />
                  Crises familiares</label
                >
                <input
                  class="detail-input"
                  type="text"
                  id="crises-detalhe"
                  placeholder="Se sim, detalhe (opcional)"
                />
              </div>

              <div class="form-group full">
                <label>Observa√ß√µes gerais</label>
                <textarea
                  id="observacoes"
                  placeholder="Observa√ß√µes adicionais (opcional)"
                  rows="4"
                ></textarea>
              </div>
              <div class="form-group full">
                <div
                  id="saveAlert"
                  class="save-alert"
                  aria-live="polite"
                  role="status"
                  style="display: none"
                >
                  Salvo com sucesso ‚úÖ
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button type="button" id="saveBtn" class="btn">
                    Salvar
                  </button>
                  <a href="/docs/Registros.html">
                    <button type="button" id="saveAndBack" class="btn btn-outline">
                      Salvar e Voltar
                    </button>
                  </a>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <footer style="max-width: 900px; margin: 24px auto; text-align: center">
        <p></p>
      </footer>
    </div>
  </body>
</html>

<script>
  (function () {
    const buttons = document.querySelectorAll(".mode-btn");
    const byName = document.querySelector(".form-by-name");
    const byCpf = document.querySelector(".form-by-cpf");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        buttons.forEach((b) => {
          b.classList.remove("active");
          b.setAttribute("aria-pressed", "false");
        });
        btn.classList.add("active");
        btn.setAttribute("aria-pressed", "true");
        const mode = btn.getAttribute("data-mode");
        if (mode === "name") {
          byName.style.display = "";
          byCpf.style.display = "none";
        } else {
          byName.style.display = "none";
          byCpf.style.display = "";
        }
      });
    });

    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = document.querySelectorAll(".tab-panel");

    tabButtons.forEach((tb) => {
      tb.addEventListener("click", () => {
        const target = tb.getAttribute("data-tab");
        tabButtons.forEach((b) => {
          b.classList.remove("active");
          b.setAttribute("aria-pressed", "false");
        });
        tabPanels.forEach((p) => (p.style.display = "none"));
        tb.classList.add("active");
        tb.setAttribute("aria-pressed", "true");
        const panel = document.querySelector(
          '.tab-panel[data-panel="' + target + '"]'
        );
        if (panel) panel.style.display = "";
      });
    });

    const toggles = document.querySelectorAll(
      'input[type="checkbox"][data-target]'
    );
    function updateDetail(checkbox) {
      const id = checkbox.getAttribute("data-target");
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = checkbox.checked ? "" : "none";
    }
    toggles.forEach((cb) => {
      const id = cb.getAttribute("data-target");
      const el = document.getElementById(id);
      if (el) {
        if (cb.checked) el.classList.add("visible");
        else el.classList.remove("visible");
      }
      cb.addEventListener("change", () => {
        if (el) {
          el.classList.toggle("visible", cb.checked);
        }
      });
    });

    const saveBtn = document.getElementById("saveBtn");
    const saveAndBack = document.getElementById("saveAndBack");
    const saveAlert = document.getElementById("saveAlert");

    function savePatient(){
      // coleta dados do formul√°rio
      const name = document.getElementById('nome').value.trim();
      const nascimento = document.getElementById('nascimento').value || '';
      const cpfEl = document.getElementById('cpf');
      const cpf = cpfEl && cpfEl.style.display !== 'none' ? cpfEl.value.trim() : '';
      const pcd = document.getElementById('pcd').checked;
      const medicacao = document.getElementById('medicacao').checked;
      const acompanhamento = document.getElementById('acompanhamento').checked;
      const acompanhante = document.getElementById('acompanhante').checked;
      const adaptacao = document.getElementById('adaptacao').checked;
      const adaptacaoDetalhe = document.getElementById('adaptacao-detalhe').value.trim();
      const dificuldade = document.getElementById('dificuldade').checked;
      const dificuldadeDetalhe = document.getElementById('dificuldade-detalhe').value.trim();
      const reprovacoes = document.getElementById('reprovacoes').checked;
      const reprovacoesDetalhe = document.getElementById('reprovacoes-detalhe').value.trim();
      const abandono = document.getElementById('abandono').checked;
      const abandonoDetalhe = document.getElementById('abandono-detalhe').value.trim();
      const malestar = document.getElementById('malestar').checked;
      const malestarDetalhe = document.getElementById('malestar-detalhe').value.trim();
      const crises = document.getElementById('crises-familiares').checked;
      const crisesDetalhe = document.getElementById('crises-detalhe').value.trim();
      const observacoes = document.getElementById('observacoes').value.trim();

      if(!name){
        saveAlert.textContent = 'Nome √© obrigat√≥rio';
        saveAlert.style.display = '';
        setTimeout(()=> saveAlert.style.display = 'none', 1800);
        return null;
      }

      const id = 'pat_' + Date.now();
      const record = {
        id, name, nascimento, cpf, pcd, medicacao, acompanhamento, acompanhante,
        adaptacao, adaptacaoDetalhe, dificuldade, dificuldadeDetalhe,
        reprovacoes, reprovacoesDetalhe, abandono, abandonoDetalhe,
        malestar, malestarDetalhe, crises, crisesDetalhe, observacoes,
        status: 'Pendente', createdAt: new Date().toISOString()
      };

      const patients = JSON.parse(localStorage.getItem('patients') || '[]');
      patients.push(record);
      localStorage.setItem('patients', JSON.stringify(patients));
      return record;
    }

    function showSaveFeedback(buttonToDisable){
      saveAlert.textContent = 'Salvo com sucesso ‚úÖ';
      saveAlert.style.display = '';
      void saveAlert.offsetWidth;
      saveAlert.classList.add('visible');
      if(buttonToDisable) buttonToDisable.disabled = true;
      setTimeout(() => {
        saveAlert.classList.remove('visible');
        if(buttonToDisable) buttonToDisable.disabled = false;
        saveAlert.style.display = 'none';
      }, 1400);
    }

    if(saveBtn){
      saveBtn.addEventListener('click', ()=>{
        const rec = savePatient();
        if(rec) showSaveFeedback(saveBtn);
      });
    }

    if(saveAndBack){
      saveAndBack.addEventListener('click', ()=>{
        const rec = savePatient();
        if(rec){
          // pequena pausa para garantir storage gravado e feedback percept√≠vel
          setTimeout(()=> location.href = 'dashboard.html', 300);
        }
      });
    }
  })();
</script>
